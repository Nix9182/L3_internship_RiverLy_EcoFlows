---
title: "10 first stations"
output: html_document
date: "2022-11-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(readxl)
library(tidyverse)
library(stringr)
library(ggpubr)
library(ggforce)
library(vegan)
library(plyr)
library(dplyr)
library(RColorBrewer)
```

```{r}
#setting the work direction
#setwd("C:\\Users\\cbodson\\Desktop\\Analyse_données")

```

```{r}
#Creating a function to clean taxa names to use as a color filter
Clean_String <-function(string) {
  new_string <- str_split(string, "_")[[1]][2]
  new_string <- str_replace_all(new_string, "[^A-Z]", "")[[1]][1]
  return(new_string)
}
```

```{r}
df <- read_excel("dataset_isotopes_compile.xlsx")
#We have to use as.character to be able to put the new collection of names while being able to use them in aes()
taxon_clean <- as.character(lapply(df$taxon, function(x){Clean_String(x)}))
#creating a new column
df["taxon_clean"]<-taxon_clean
#getting rid of the aspartame data as it used only for calibration 
df<- df[df$taxon_clean !=as.character('ASP'),]
```

```{r}
#set limits for axis
xmin <- -38.5
xmax <- -24
ymin <- 1
ymax <- 11
```


```{r}
#define common color palette for all taxon plots
myColors <- c("#AF6158","#ffba08","#8DCB41","#608E5C","#18D2BC","#3185fc","#A95AF8","#46237a","#E87F99","#FF5B36")
#add color-taxon consistency
names(myColors) <- unique(df$taxon_clean)
colScale <- scale_colour_manual(name = "Taxa",values = myColors)

all <- ggplot(df)+geom_point(aes(d13C_norm,d15N_norm,
                                 color=taxon_clean))+xlim(xmin,xmax)+ylim(ymin,ymax)+xlab('δ13C (‰)')+ylab('δ15N (‰)')+colScale
all
```

```{r}
#Creating functions that take taxon name or land type and plot the scatterplot of the desired category
Plotify_taxon <- function(taxon_name) {
    plot <- ggplot(df[df$taxon_clean ==as.character(taxon_name),])+geom_point(aes(d13C_norm,d15N_norm, color=type))+xlim(xmin,xmax)+ylim(ymin,ymax)+xlab('δ13C (‰)')+ylab('δ15N (‰)')
}

Plotify_type <- function(type_land) {
    plot <- ggplot(df[df$type ==as.character(type_land),])+geom_point(aes(d13C_norm,d15N_norm, color=taxon_clean))+xlim(xmin,xmax)+ylim(ymin,ymax)+xlab('δ13C (‰)')+ylab('δ15N (‰)')+colScale
}

Plotify_taxon_type <- function(taxon_name, type_land) {
    plot <- ggplot(df[df$taxon_clean ==as.character(taxon_name) & df$type ==as.character(type_land) ,])+geom_point(aes(d13C_norm,d15N_norm, color=station))+xlim(xmin,xmax)+ylim(ymin,ymax)+xlab('δ13C (‰)')+ylab('δ15N (‰)')
}


#Functions to plot boxplots depending on carbon or nitrogen for each taxon with type of land use as categories
Boxplot_carbon_taxon <- function(taxon_name) {
  plot <- ggplot(df[df$taxon_clean ==as.character(taxon_name),])+geom_boxplot(aes(type,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Land Use')+ylab('δ13C (‰)')
}

Boxplot_nitrogen_taxon <- function(taxon_name) {
  plot <- ggplot(df[df$taxon_clean ==as.character(taxon_name),])+geom_boxplot(aes(type,d15N_norm))+ylim(ymin,ymax)+xlab('Land Use')+ylab('δ15N (‰)')
}

#Function to add trophic role 
Trophify <- function(taxon_name) {
  if (taxon_name == 'SIMU' | taxon_name == 'HYDROP') {
    troph <- 'Collector'
  } 
  else if (taxon_name == 'BAET' | taxon_name == 'HEPTA') {
    troph <- 'Grazer'
  } 
  else if (taxon_name == 'GAM') {
    troph <- 'Shredder'
  } 
  else if (taxon_name == 'CALOP' | taxon_name == 'RHYACO' | taxon_name == 'PERL') {
    troph <- 'Predator'
  } 
  else if (taxon_name == 'TRF' | taxon_name == 'VAI') {
    troph <- 'Fish'
  } 
}
```

```{r}
df$Troph_func <- as.character(lapply(df$taxon_clean, function(x){Trophify(x)}))
```

```{r}
baet <- Plotify_taxon('BAET')
calop <- Plotify_taxon('CALOP')
simu <- Plotify_taxon('SIMU')
hepta <- Plotify_taxon('HEPTA')
gam <- Plotify_taxon('GAM')
hydrop <- Plotify_taxon('HYDROP')
perl <- Plotify_taxon('PERL')
rhyaco <- Plotify_taxon('RHYACO')
vai <- Plotify_taxon('VAI')
trf <- Plotify_taxon('TRF')
```

```{r}
bois <- Plotify_type('bois')
friche <- Plotify_type('friche')
prairie <- Plotify_type('prairie')
resineux <- Plotify_type('resineux')

#creates a hull for isotopic area

bois_hull <- bois+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=taxon_clean), expand = 0, radius = 0)
friche_hull <- friche+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=taxon_clean), expand = 0, radius = 0)
prairie_hull <- prairie+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=taxon_clean), expand = 0, radius = 0)
resineux_hull <- resineux+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=taxon_clean), expand = 0, radius = 0)

```

Isotopic frame in function of land use, not the most judicious as we separate the factors we want to compare

```{r}
ggarrange(bois, friche, prairie, resineux, 
          labels = c("bois", "friche", "prairie", "resineux"),
          ncol=2,
          nrow = 2)
```

Same with isotopic areas

```{r}
ggarrange(bois_hull, friche_hull, prairie_hull, resineux_hull, 
          labels = c("bois", "friche", "prairie", "resineux"),
          ncol=2,
          nrow = 2)
```

Isotopic frame by taxon

```{r}
ggarrange(baet,calop,gam,hepta,hydrop,perl,rhyaco,simu,vai,trf, 
          labels = c("baet","calop","gam","hepta","hydrop","perl","rhyaco","simu","vai","trf"),
          ncol=4,
          nrow = 3)
```
Areas for each taxon in function of land use
+ procedure for PERMANOVA to test wether clusters are different two by two

```{r}
#Adonis doesn't want negative values for PERMANOVA
df$C_absolute <- as.numeric(lapply(df$d13C_norm, function(x){abs(x)}))
```

```{r}
Test_hull_taxon <- function(taxon_name){

#Initializing vector with pairwise test p_values
pairwise_p <- numeric()
pairwise_r2 <- numeric()

taxon_test <-df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute')]

set.seed(46) #to ensure reproducibilty as we use permutations


ado_all <-adonis2(taxon_test~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')])

#Takes p-value and R2 results
pairwise_p['all'] <- ado_all$`Pr(>F)`[1]
pairwise_r2['all'] <- ado_all$R2[1]

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
  taxon_bf <- df[df$taxon_clean== as.character(taxon_name),] %>%  #clean with only land uses of interest
    filter(type =='bois'|type=='friche') %>%
    select(c('d15N_norm','C_absolute'))
  ado_bf <-adonis2(taxon_bf~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%filter(type =='bois'|type=='friche'))
  pairwise_p['bois vs. friche'] <- ado_bf$`Pr(>F)`[1]
  pairwise_r2['bois vs. friche'] <- ado_bf$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')){
taxon_bp <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='bois'|type=='prairie') %>%
  select(c('d15N_norm','C_absolute'))
ado_bp <-adonis2(taxon_bp~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='bois'|type=='prairie'))
pairwise_p['bois vs. prairie'] <- ado_bp$`Pr(>F)`[1]
pairwise_r2['bois vs. prairie'] <- ado_bp$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
taxon_pf <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='prairie'|type=='friche') %>%
  select(c('d15N_norm','C_absolute'))
ado_pf <-adonis2(taxon_pf~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='prairie'|type=='friche'))
pairwise_p['prairie vs. friche'] <- ado_pf$`Pr(>F)`[1]
pairwise_r2['prairie vs. friche'] <- ado_pf$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')){
taxon_br <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='bois'|type=='resineux') %>%
  select(c('d15N_norm','C_absolute'))
ado_br <-adonis2(taxon_br~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='bois'|type=='resineux'))
pairwise_p['bois vs. resineux'] <- ado_br$`Pr(>F)`[1]
pairwise_r2['bois vs. resineux'] <- ado_br$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
taxon_rf <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='resineux'|type=='friche') %>%
  select(c('d15N_norm','C_absolute'))
ado_rf <-adonis2(taxon_rf~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='resineux'|type=='friche'))
pairwise_p['resineux vs. friche'] <- ado_rf$`Pr(>F)`[1]
pairwise_r2['resineux vs. friche'] <- ado_rf$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')){
taxon_rp <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='resineux'|type=='prairie') %>%
  select(c('d15N_norm','C_absolute'))
ado_rp <-adonis2(taxon_rp~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='resineux'|type=='prairie'))
pairwise_p['resineux vs. prairie'] <- ado_rp$`Pr(>F)`[1]
pairwise_r2['resineux vs. prairie'] <- ado_rp$R2[1]
}

#As we increase the number of comparisons, we also increase the risk of rejecting the false hypothesis so we need to adjust p-values
adjusted_pairwise_p <- data.frame(t(data.frame(p.adjust(pairwise_p))))
rownames(adjusted_pairwise_p) <- 'pairwise_p'
data.frame(t(data.frame(pairwise_r2)))

return(rbind(adjusted_pairwise_p,data.frame(t(data.frame(pairwise_r2)))))
}

```

```{r}
baet+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Baetidae ")
```
```{r}
Test_hull_taxon('BAET')
```

```{r}
calop+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Calopterygidae ")
```
```{r}
Test_hull_taxon('CALOP')
```

```{r}
gam+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Gammaridae ")
```
```{r}
Test_hull_taxon('GAM')
```

```{r}
hepta+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Heptagenidae ")
```
```{r}
Test_hull_taxon('HEPTA')
```

```{r}
hydrop+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Hydropsychidae ")
```
```{r}
Test_hull_taxon('HYDROP')
```

```{r}
perl+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Perlidae ")
```
```{r}
Test_hull_taxon('PERL')
```

```{r}
rhyaco+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Rhyacophilidae ")
```
```{r}
Test_hull_taxon('RHYACO')
```

```{r}
simu+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Simulidae ")
```
```{r}
Test_hull_taxon('SIMU')
```

```{r}
vai+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Phoxinus phoxinus (Common Minnow) ")
```
```{r}
Test_hull_taxon('VAI')
```

```{r}
trf+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+ggtitle("Isotopic areas concerning Salmo trutta (Brown trout) ")
```

```{r}
Test_hull_taxon('TRF')
```

```{r}
#Gathering all data into 2 dataframes, p-values indicate significance of the difference observed whether it's small or large, and R2 indicate the proportion of variation explained by the model (here by the type of land use)
df_p_values <- rbind.fill(Test_hull_taxon('BAET')['pairwise_p',],
                          Test_hull_taxon('CALOP')['pairwise_p',],
                          Test_hull_taxon('GAM')['pairwise_p',],
                          Test_hull_taxon('HEPTA')['pairwise_p',],
                          Test_hull_taxon('HYDROP')['pairwise_p',],
                          Test_hull_taxon('PERL')['pairwise_p',],
                          Test_hull_taxon('RHYACO')['pairwise_p',],
                          Test_hull_taxon('SIMU')['pairwise_p',],
                          Test_hull_taxon('VAI')['pairwise_p',],
                          Test_hull_taxon('TRF')['pairwise_p',])
rownames(df_p_values) <- c('BAET','CALOP','GAM','HEPTA','HYDROP','PERL','RHYACO','SIMU','VAI','TRF')

df_r2_values <- rbind.fill(Test_hull_taxon('BAET')['pairwise_r2',],
                          Test_hull_taxon('CALOP')['pairwise_r2',],
                          Test_hull_taxon('GAM')['pairwise_r2',],
                          Test_hull_taxon('HEPTA')['pairwise_r2',],
                          Test_hull_taxon('HYDROP')['pairwise_r2',],
                          Test_hull_taxon('PERL')['pairwise_r2',],
                          Test_hull_taxon('RHYACO')['pairwise_r2',],
                          Test_hull_taxon('SIMU')['pairwise_r2',],
                          Test_hull_taxon('VAI')['pairwise_r2',],
                          Test_hull_taxon('TRF')['pairwise_r2',])
rownames(df_r2_values) <- c('BAET','CALOP','GAM','HEPTA','HYDROP','PERL','RHYACO','SIMU','VAI','TRF')

df_r2_values
df_p_values
```



Look further in detail at stations to identify a possible explanation for the 2 "branches" with large difference δ15N observed for prairies across the taxa 

```{r}
ggplot(df[df$type ==as.character('prairie'),])+geom_point(aes(d13C_norm,d15N_norm, color=station))+ggtitle("Isotopic frame for all taxa depending on the prairie station ")+xlab('δ13C (‰)')+ylab('δ15N (‰)')+xlim(xmin,xmax)+ylim(ymin,ymax)
```
Same but taxon by taxon

```{r}
baet_prairie <- Plotify_taxon_type('BAET','prairie')
calop_prairie <- Plotify_taxon_type('CALOP','prairie')
simu_prairie <- Plotify_taxon_type('SIMU','prairie')
hepta_prairie <- Plotify_taxon_type('HEPTA','prairie')
gam_prairie <- Plotify_taxon_type('GAM','prairie')
hydrop_prairie <- Plotify_taxon_type('HYDROP','prairie')
perl_prairie <- Plotify_taxon_type('PERL','prairie')
rhyaco_prairie <- Plotify_taxon_type('RHYACO','prairie')
vai_prairie <- Plotify_taxon_type('VAI','prairie')
trf_prairie <- Plotify_taxon_type('TRF','prairie')
```

```{r}
ggarrange(baet_prairie,calop_prairie,gam_prairie,hepta_prairie,hydrop_prairie,perl_prairie,rhyaco_prairie,simu_prairie,vai_prairie,trf_prairie, 
          labels = c("baet","calop","gam","hepta","hydrop","perl","rhyaco","simu","vai","trf"),
          ncol=4,
          nrow = 3)
```
Boxplots

```{r}
bois_bc <- ggplot(df[df$type ==as.character('bois'),])+geom_boxplot(aes(taxon_clean,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Taxa')+ylab('δ13C (‰)')
prairie_bc <- ggplot(df[df$type ==as.character('prairie'),])+geom_boxplot(aes(taxon_clean,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Taxa')+ylab('δ13C (‰)')
friche_bc  <- ggplot(df[df$type ==as.character('friche'),])+geom_boxplot(aes(taxon_clean,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Taxa')+ylab('δ13C (‰)')
resineux_bc <- ggplot(df[df$type ==as.character('resineux'),])+geom_boxplot(aes(taxon_clean,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Taxa')+ylab('δ13C (‰)')

bois_bn <- ggplot(df[df$type ==as.character('bois'),])+geom_boxplot(aes(taxon_clean,d15N_norm))+ylim(ymin,ymax)+xlab('Taxa')+ylab('δ15N (‰)')
prairie_bn <- ggplot(df[df$type ==as.character('prairie'),])+geom_boxplot(aes(taxon_clean,d15N_norm))+ylim(ymin,ymax)+xlab('Taxa')+ylab('δ15N (‰)')
friche_bn  <- ggplot(df[df$type ==as.character('friche'),])+geom_boxplot(aes(taxon_clean,d15N_norm))+ylim(ymin,ymax)+xlab('Taxa')+ylab('δ15N (‰)')
resineux_bn <- ggplot(df[df$type ==as.character('resineux'),])+geom_boxplot(aes(taxon_clean,d15N_norm))+ylim(ymin,ymax)+xlab('Taxa')+ylab('δ15N (‰)')
```

```{r}
baet_box_carbon <- Boxplot_carbon_taxon('BAET')
calop_box_carbon <- Boxplot_carbon_taxon('CALOP')
gam_box_carbon <- Boxplot_carbon_taxon('GAM')
hepta_box_carbon <- Boxplot_carbon_taxon('HEPTA')
hydrop_box_carbon <- Boxplot_carbon_taxon('HYDROP')
perl_box_carbon <- Boxplot_carbon_taxon('PERL')
rhyaco_box_carbon <- Boxplot_carbon_taxon('RHYACO')
simu_box_carbon <- Boxplot_carbon_taxon('SIMU')
trf_box_carbon <- Boxplot_carbon_taxon('TRF')
vai_box_carbon <- Boxplot_carbon_taxon('VAI')

baet_box_nitrogen <- Boxplot_nitrogen_taxon('BAET')
calop_box_nitrogen <- Boxplot_nitrogen_taxon('CALOP')
gam_box_nitrogen <- Boxplot_nitrogen_taxon('GAM')
hepta_box_nitrogen <- Boxplot_nitrogen_taxon('HEPTA')
hydrop_box_nitrogen <- Boxplot_nitrogen_taxon('HYDROP')
perl_box_nitrogen <- Boxplot_nitrogen_taxon('PERL')
rhyaco_box_nitrogen <- Boxplot_nitrogen_taxon('RHYACO')
simu_box_nitrogen <- Boxplot_nitrogen_taxon('SIMU')
trf_box_nitrogen <- Boxplot_nitrogen_taxon('TRF')
vai_box_nitrogen <- Boxplot_nitrogen_taxon('VAI')

```


Boxplot by taxon for Carbon
```{r}

ggarrange(baet_box_carbon,calop_box_carbon,gam_box_carbon,hepta_box_carbon,hydrop_box_carbon,perl_box_carbon,rhyaco_box_carbon,simu_box_carbon,vai_box_carbon,trf_box_carbon, 
          labels = c("baet","calop","gam","hepta","hydrop","perl","rhyaco","simu","vai","trf"),
          ncol=4,
          nrow = 3)
```


```{r}
#create function with Welch Two sample t-tests significant results as output

t_test_type_alt <- function(taxon_name,type1,type2,alternative_asked){
  x <- df[df$taxon_clean == as.character(taxon_name),]%>%
         filter(type ==as.character(type1)) %>%
         select('d13C_norm')
  y <- df[df$taxon_clean == as.character(taxon_name),]%>%
         filter(type ==as.character(type2)) %>%
         select('d13C_norm')
  if (nrow(x)>1 & nrow(y)>1){
  test <- t.test(x,y,alternative=as.character(alternative_asked))
  }
  else {
    test <- NaN
  }
  return(test)
}
```


```{r}
c_mean_t_test <- function(taxon_name) {
  #create empty df
  c_mean_colnames <- c('different','greater','less','taxon')
  c_mean_df <- data.frame(matrix(nrow=length(c(colnames(df_p_values)[c(2:length(df_p_values))])),ncol=length(c_mean_colnames)))
  colnames(c_mean_df) <- c_mean_colnames
  c_mean_df$taxon <- rep(taxon_name,nrow(c_mean_df))
  c_mean_df$comparison <- c(colnames(df_p_values)[c(2:length(df_p_values))])
  
  #significance threshold
  thr <- 0.05
  
  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
    test_two_sided <- t_test_type_alt(taxon_name,'bois','friche','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'bois','friche','greater')
    test_less <- t_test_type_alt(taxon_name,'bois','friche','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {
        if (i < thr){
         c_mean_df[1,match(i,test_list)] <- TRUE
        }
        else{
         c_mean_df[1,match(i,test_list)] <- FALSE
        }
      }
    }
  }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')){
    test_two_sided <- t_test_type_alt(taxon_name,'bois','prairie','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'bois','prairie','greater')
    test_less <- t_test_type_alt(taxon_name,'bois','prairie','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {      
        if (i < thr){
          c_mean_df[2,match(i,test_list)] <- TRUE
        }
        else{
          c_mean_df[2,match(i,test_list)] <- FALSE
        }
       }
     }
   }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
    test_two_sided <- t_test_type_alt(taxon_name,'prairie','friche','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'prairie','friche','greater')
    test_less <- t_test_type_alt(taxon_name,'prairie','friche','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
       for (i in test_list) { 
        if (i < thr){
         c_mean_df[3,match(i,test_list)] <- TRUE
        }
        else{
         c_mean_df[3,match(i,test_list)] <- FALSE
        }
       }
     }
  }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')){
    test_two_sided <- t_test_type_alt(taxon_name,'bois','resineux','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'bois','resineux','greater')
    test_less <- t_test_type_alt(taxon_name,'bois','resineux','less')
    
    
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
        test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
        for (i in test_list) {
          if (i < thr){
           c_mean_df[4,match(i,test_list)] <- TRUE
          }
          else{
           c_mean_df[4,match(i,test_list)] <- FALSE
          }
        }
      }
  }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
    test_two_sided <- t_test_type_alt(taxon_name,'resineux','friche','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'resineux','friche','greater')
    test_less <- t_test_type_alt(taxon_name,'resineux','friche','less')
    
      if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
        test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
        for (i in test_list) {     
          if (i < thr){
            c_mean_df[5,match(i,test_list)] <- TRUE
          }
          else{
            c_mean_df[5,match(i,test_list)] <- FALSE
          }
        }
      }
  }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')){
    test_two_sided <- t_test_type_alt(taxon_name,'resineux','prairie','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'resineux','prairie','greater')
    test_less <- t_test_type_alt(taxon_name,'resineux','prairie','less')
    
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {
       if (i < thr){
        c_mean_df[6,match(i,test_list)] <- TRUE
       }
       else{
        c_mean_df[6,match(i,test_list)] <- FALSE
       }
      }
    }
  }
  
return(c_mean_df)
}
```

```{r}
c_mean_baet <- c_mean_t_test('BAET')
c_mean_calop <- c_mean_t_test('CALOP')
c_mean_gam <- c_mean_t_test('GAM')
c_mean_hepta <- c_mean_t_test('HEPTA')
c_mean_hydrop <- c_mean_t_test('HYDROP')
c_mean_perl <- c_mean_t_test('PERL')
c_mean_rhyaco <- c_mean_t_test('RHYACO')
c_mean_simu <- c_mean_t_test('SIMU')
c_mean_vai <- c_mean_t_test('VAI')
c_mean_trf <- c_mean_t_test('TRF')
c_mean_all <- rbind(c_mean_baet,c_mean_calop,c_mean_gam,c_mean_hepta,c_mean_hydrop,c_mean_perl,c_mean_rhyaco,c_mean_simu,c_mean_vai,c_mean_trf)
```


Boxplot by taxon for Nitrogen
```{r}
ggarrange(baet_box_nitrogen,calop_box_nitrogen,gam_box_nitrogen,hepta_box_nitrogen,hydrop_box_nitrogen,perl_box_nitrogen,rhyaco_box_nitrogen,simu_box_nitrogen,vai_box_nitrogen,trf_box_nitrogen, 
          labels = c("baet","calop","gam","hepta","hydrop","perl","rhyaco","simu","vai","trf"),
          ncol=4,
          nrow = 3)
```
Same by lund use type, but not the most judicious
```{r}
ggarrange(bois_bc, friche_bc, prairie_bc, resineux_bc, 
          labels = c("bois", "friche", "prairie", "resineux"),
          ncol=2,
          nrow = 2)
```

```{r}
ggarrange(bois_bn, friche_bn, prairie_bn, resineux_bn, 
          labels = c("bois", "friche", "prairie", "resineux"),
          ncol=2,
          nrow = 2)
```
Looking further into impact feeding behavior
```{r}
ggplot(df[df$type ==as.character('prairie'),])+geom_point(aes(d13C_norm,d15N_norm, color=Troph_func))
```
