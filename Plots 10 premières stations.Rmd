---
title: "10 first stations"
output: html_document
date: "2022-11-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(readxl)
library(tidyverse)
library(stringr)
library(ggpubr)
library(ggforce)
library(vegan)
library(plyr)
library(dplyr)
library(RColorBrewer)
library(rstatix)
library(xlsx)
```



```{r}
Clean_String<-function(string) {
  # new_string <- str_split(string, c("_"))[[1]]
  # new_string <- str_split(new_string, c(" "))
  new_string<- strsplit(string, "[- _0-9]")[[1]]
  for (str in new_string) {
  if (str %in% c("ASP", "CAS", "BAET","CALOP","GAM","GAMM","HEPTA","HYDROP","HYDRO","PERL","RHYACO", "RHYACOsp", "SIMU","SIMUL","VAI","TRF")) {
    new_string <-str
    break
  }
  }
  return(new_string)
}
```

```{r}
df1 <- read_excel("dataset_isotopes_compile.xlsx")
df2 <- read_excel("dataset_isotopes_compile_second.xlsx")
df <- rbind(df1,df2)
#We have to use as.character to be able to put the new collection of names while being able to use them in aes()
taxon_clean <- as.character(lapply(df$taxon, function(x){Clean_String(x)}))
#creating a new column
df["taxon_clean"]<-taxon_clean
df$taxon_clean[df$taxon_clean=="GAMM"] <- "GAM"
df$taxon_clean[df$taxon_clean=="HYDRO"] <- "HYDROP"
df$taxon_clean[df$taxon_clean=="SIMUL"] <- "SIMU"
df$taxon_clean[df$taxon_clean=="RHYACOsp"] <- "RHYACO"
df$type[df$type=="Bois"] <- "bois"
#getting rid of the aspartame data as it used only for calibration 
df<- df[df$taxon_clean !=as.character('ASP'),]
```

```{r}
#set limits for axis
xmin <- -40
xmax <- -23
ymin <- 1
ymax <- 12
```


```{r}
#define common color palette for all taxon plots
myColors <- c("#AF6158","#ffba08","#8DCB41","#608E5C","#18D2BC","#3185fc","#A95AF8","#46237a","#E87F99","#FF5B36")
#add color-taxon consistency
names(myColors) <- unique(df$taxon_clean)
colScale <- scale_colour_manual(name = "Taxa",values = myColors, labels= c('Baetidae', 'Calopterygidae', 'Gammaridae', 'Heptageniidae', 'Hydropsychidae', 'Perlidae', 'Rhyacophilidae', 'Simuliidae', 'Salmo Trutta', 'Phoxinus phoxinus'))

#define common color palette for all taxon plots
all <- ggplot(df)+geom_point(aes(d13C_norm,d15N_norm,color=taxon_clean))+xlim(xmin,xmax)+ylim(ymin,ymax)+labs(x = 'δ13C (‰)', y = 'δ15N (‰)')+colScale+theme_bw()
all
```

```{r}
#Creating functions that take taxon name or land type and plot the scatterplot of the desired category
Plotify_taxon <- function(taxon_name) {
    plot <- ggplot(df[df$taxon_clean ==as.character(taxon_name),])+geom_point(aes(d13C_norm,d15N_norm, color=type))+xlim(xmin,xmax)+ylim(ymin,ymax)+labs(x = 'δ13C (‰)', y = 'δ15N (‰)')+theme_bw()+theme(plot.margin=unit(c(1,0.5,0,0.5),"cm"))
}

Plotify_type <- function(type_land) {
    plot <- ggplot(df[df$type ==as.character(type_land),])+geom_point(aes(d13C_norm,d15N_norm, color=taxon_clean))+xlim(xmin,xmax)+ylim(ymin,ymax)+labs(x = 'δ13C (‰)', y = 'δ15N (‰)')+colScale+theme_bw()+theme(plot.margin=unit(c(1,0.5,-0.5,0.5),"cm"))
}

Plotify_taxon_type <- function(taxon_name, type_land) {
    plot <- ggplot(df[df$taxon_clean ==as.character(taxon_name) & df$type ==as.character(type_land) ,])+geom_point(aes(d13C_norm,d15N_norm, color=station))+xlim(xmin,xmax)+ylim(ymin,ymax)+labs(x = 'δ13C (‰)', y = 'δ15N (‰)')+theme_bw()+theme(plot.margin=unit(c(1,0.5,0,0.5),"cm"))
}

Plotify_troph_type <- function(troph, type_land) {
    plot <- ggplot(df[df$troph_func ==as.character(troph) & df$type ==as.character(type_land) ,])+geom_point(aes(d13C_norm,d15N_norm, color=station))+xlim(xmin,xmax)+ylim(ymin,ymax)+labs(x = 'δ13C (‰)', y = 'δ15N (‰)')+theme_bw()+theme(plot.margin=unit(c(1,0.5,0,0.5),"cm"))
}

#Functions to plot boxplots depending on carbon or nitrogen for each taxon with type of land use as categories
Boxplot_carbon_taxon <- function(taxon_name) {
  plot <- ggplot(df[df$taxon_clean ==as.character(taxon_name),])+geom_boxplot(aes(type,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Land Use')+ylab('δ13C (‰)')+theme_bw()
}

Boxplot_nitrogen_taxon <- function(taxon_name) {
  plot <- ggplot(df[df$taxon_clean ==as.character(taxon_name),])+geom_boxplot(aes(type,d15N_norm))+ylim(ymin,ymax)+xlab('Land Use')+ylab('δ15N (‰)')+theme_bw()
}

#Function to add trophic role 
Trophify <- function(taxon_name) {
  if (taxon_name == 'SIMU' | taxon_name == 'HYDROP') {
    troph <- 'Collector'
  } 
  else if (taxon_name == 'BAET' | taxon_name == 'HEPTA') {
    troph <- 'Grazer'
  } 
  else if (taxon_name == 'GAM') {
    troph <- 'Shredder'
  } 
  else if (taxon_name == 'CALOP' | taxon_name == 'RHYACO' | taxon_name == 'PERL') {
    troph <- 'Predator'
  } 
  else if (taxon_name == 'TRF' | taxon_name == 'VAI') {
    troph <- 'Fish'
  } 
}

df$troph_func <- as.character(lapply(df$taxon_clean, function(x){Trophify(x)}))

Plotify_troph <- function(troph){
  plot <- ggplot(df[df$troph_func ==as.character(troph),])+geom_point(aes(d13C_norm,d15N_norm, color=type))+xlim(xmin,xmax)+ylim(ymin,ymax)+labs(x = 'δ13C (‰)', y = 'δ15N (‰)')+theme_bw()+theme(plot.margin=unit(c(1,0.5,0,0.5),"cm"))
}
```


Isotopic frame by feeding behavior
```{r}
collector <- Plotify_troph('Collector')
grazer <- Plotify_troph('Grazer')
shredder <- Plotify_troph('Shredder')
predator <- Plotify_troph("Predator")
fish <- Plotify_troph("Fish")
```

```{r}
#ggarange takes the legend of the first plot for common legends
#png("C:/Users/cbodson/Desktop/Isotopic_Frame_by_taxon.png", width=750, height=500)
ggarrange(collector+scale_color_manual(name='Land Use',values=c("#F8766D","#7CAE00","#00BFC4","#C77CFF"), labels=c("Woods","Wastelands","Prairies","Softwoods")),grazer,shredder,predator,fish, 
          labels = c('Collector','Grazer','Shredder','Predator','Fish'),
          ncol=3,
          nrow = 2,
          label.x = 0.1,
          common.legend=TRUE,
          legend="right")
#dev.off()
```
Areas for each feeding behavior in function of land use
+ procedure for PERMANOVA to test whether clusters are different two by two 
```{r}
#Adonis doesn't want negative values for PERMANOVA
df$C_absolute <- as.numeric(lapply(df$d13C_norm, function(x){abs(x)}))
```

```{r}
Test_hull_troph <- function(troph){

#Initializing vector with pairwise test p_values
pairwise_p <- numeric()
pairwise_r2 <- numeric()

troph_test <-df[df$troph_func== as.character(troph), c('d15N_norm','C_absolute')]

set.seed(46) #to ensure reproducibilty as we use permutations


ado_all <-adonis2(troph_test~type,data=df[df$troph_func== as.character(troph), c('d15N_norm','C_absolute','type')])

#Takes p-value and R2 results
pairwise_p['all'] <- ado_all$`Pr(>F)`[1]
pairwise_r2['all'] <- ado_all$R2[1]

if (any(df[df$troph_func== as.character(troph),]$type == 'bois')& any(df[df$troph_func== as.character(troph),]$type == 'friche')){
  taxon_bf <- df[df$troph_func== as.character(troph),] %>%  #clean with only land uses of interest
    filter(type =='bois'|type=='friche') %>%
    select(c('d15N_norm','C_absolute'))
  ado_bf <-adonis2(taxon_bf~type,data=df[df$troph_func== as.character(troph), c('d15N_norm','C_absolute','type')]%>%filter(type =='bois'|type=='friche'))
  pairwise_p['bois vs. friche'] <- ado_bf$`Pr(>F)`[1]
  pairwise_r2['bois vs. friche'] <- ado_bf$R2[1]
}

if (any(df[df$troph_func== as.character(troph),]$type == 'bois')& any(df[df$troph_func== as.character(troph),]$type == 'prairie')){
taxon_bp <- df[df$troph_func== as.character(troph),] %>%
  filter(type =='bois'|type=='prairie') %>%
  select(c('d15N_norm','C_absolute'))
ado_bp <-adonis2(taxon_bp~type,data=df[df$troph_func== as.character(troph), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='bois'|type=='prairie'))
pairwise_p['bois vs. prairie'] <- ado_bp$`Pr(>F)`[1]
pairwise_r2['bois vs. prairie'] <- ado_bp$R2[1]
}

if (any(df[df$troph_func== as.character(troph),]$type == 'prairie')& any(df[df$troph_func== as.character(troph),]$type == 'friche')){
taxon_pf <- df[df$troph_func== as.character(troph),] %>%
  filter(type =='prairie'|type=='friche') %>%
  select(c('d15N_norm','C_absolute'))
ado_pf <-adonis2(taxon_pf~type,data=df[df$troph_func== as.character(troph), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='prairie'|type=='friche'))
pairwise_p['prairie vs. friche'] <- ado_pf$`Pr(>F)`[1]
pairwise_r2['prairie vs. friche'] <- ado_pf$R2[1]
}

if (any(df[df$troph_func== as.character(troph),]$type == 'bois')& any(df[df$troph_func== as.character(troph),]$type == 'resineux')){
taxon_br <- df[df$troph_func== as.character(troph),] %>%
  filter(type =='bois'|type=='resineux') %>%
  select(c('d15N_norm','C_absolute'))
ado_br <-adonis2(taxon_br~type,data=df[df$troph_func== as.character(troph), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='bois'|type=='resineux'))
pairwise_p['bois vs. resineux'] <- ado_br$`Pr(>F)`[1]
pairwise_r2['bois vs. resineux'] <- ado_br$R2[1]
}

if (any(df[df$troph_func== as.character(troph),]$type == 'resineux')& any(df[df$troph_func== as.character(troph),]$type == 'friche')){
taxon_rf <- df[df$troph_func== as.character(troph),] %>%
  filter(type =='resineux'|type=='friche') %>%
  select(c('d15N_norm','C_absolute'))
ado_rf <-adonis2(taxon_rf~type,data=df[df$troph_func== as.character(troph), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='resineux'|type=='friche'))
pairwise_p['resineux vs. friche'] <- ado_rf$`Pr(>F)`[1]
pairwise_r2['resineux vs. friche'] <- ado_rf$R2[1]
}

if (any(df[df$troph_func== as.character(troph),]$type == 'resineux')& any(df[df$troph_func== as.character(troph),]$type == 'prairie')){
taxon_rp <- df[df$troph_func== as.character(troph),] %>%
  filter(type =='resineux'|type=='prairie') %>%
  select(c('d15N_norm','C_absolute'))
ado_rp <-adonis2(taxon_rp~type,data=df[df$troph_func== as.character(troph), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='resineux'|type=='prairie'))
pairwise_p['resineux vs. prairie'] <- ado_rp$`Pr(>F)`[1]
pairwise_r2['resineux vs. prairie'] <- ado_rp$R2[1]
}

#As we increase the number of comparisons, we also increase the risk of rejecting the false hypothesis so we need to adjust p-values
adjusted_pairwise_p <- data.frame(t(data.frame(p.adjust(pairwise_p))))
rownames(adjusted_pairwise_p) <- 'pairwise_p'
data.frame(t(data.frame(pairwise_r2)))

return(rbind(adjusted_pairwise_p,data.frame(t(data.frame(pairwise_r2)))))
}

```

```{r}
#Gathering all data into 2 dataframes, p-values indicate significance of the difference observed whether it's small or large, and R2 indicate the proportion of variation explained by the model (here by the type of land use)

df_p_values_troph <- rbind.fill(Test_hull_troph('Collector')['pairwise_p',],
                          Test_hull_troph('Grazer')['pairwise_p',],
                          Test_hull_troph('Shredder')['pairwise_p',],
                          Test_hull_troph('Predator')['pairwise_p',],
                          Test_hull_troph('Fish')['pairwise_p',])
rownames(df_p_values_troph) <- c('Collectors', 'Grazers', 'Shredders', 'Predators', 'Fish')
colnames(df_p_values_troph) <- c('All', "Woods/Wasteland"," Woods/Prairies", "Prairies/Wasteland", "Woods/Softwoods", "Softwoods/Wasteland", "Softwoods/Prairies")

df_r2_values_troph <- rbind.fill(Test_hull_troph('Collector')['pairwise_r2',],
                          Test_hull_troph('Grazer')['pairwise_r2',],
                          Test_hull_troph('Shredder')['pairwise_r2',],
                          Test_hull_troph('Predator')['pairwise_r2',],
                          Test_hull_troph('Fish')['pairwise_r2',])
                          
rownames(df_r2_values_troph) <- c('Collectors', 'Grazers', 'Shredders', 'Predators', 'Fish')
colnames(df_r2_values_troph) <- c('All', "Woods/Wasteland"," Woods/Prairies", "Prairies/Wasteland", "Woods/Softwoods", "Softwoods/Wasteland", "Softwoods/Prairies")

df_r2_values_troph <- df_r2_values_troph%>%  mutate_if(is.numeric, round, digits = 3)
df_p_values_troph
```


```{r}
mask_df_troph <- data.frame(lapply(df_p_values_troph, function(x){x<0.05}))
df_r2_signi_troph <- data.frame(mapply(function(x, y) ifelse(y, x, "X"), df_r2_values_troph, mask_df_troph))
rownames(df_r2_signi_troph) <- c('Collectors', 'Grazers', 'Shredders', 'Predators', 'Fish')
colnames(df_r2_signi_troph) <- c('All', "Woods/Wasteland"," Woods/Prairies", "Prairies/Wasteland", "Woods/Softwoods", "Softwoods/Wasteland", "Softwoods/Prairies")
df_r2_signi_troph
```


```{r}
# #setting the work direction
# setwd("C:\\Users\\cbodson\\Desktop")
# write.xlsx(df_r2_signi_troph, "Troph_areas_r2_significant.xlsx")
```

```{r}
collector_hull <- collector+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))

grazer_hull <- grazer+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))

shredder_hull <- shredder+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))

predator_hull <- predator+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))

fish_hull <- fish+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```

```{r}
ggarrange(collector_hull,grazer_hull,shredder_hull,predator_hull,fish_hull,
          labels = c('Collector','Grazer','Shredder','Predator','Fish'),
          ncol=3,
          nrow = 2,
          label.x = 0.1,
          common.legend=TRUE,
          legend="right")
```



Look further in detail at stations to identify a possible explanation for the 2 "branches" with large difference δ15N observed for prairies across the taxa 

```{r}
ggplot(df[df$type ==as.character('prairie'),])+geom_point(aes(d13C_norm,d15N_norm, color=station))+xlab('δ13C (‰)')+ylab('δ15N (‰)')+xlim(xmin,xmax)+ylim(ymin,ymax)+theme_bw()
```

Same but troph by troph 
```{r}
collector_prairie <- Plotify_troph_type("Collector", "prairie")
grazer_prairie <- Plotify_troph_type("Grazer", "prairie")
shredder_prairie <- Plotify_troph_type("Shredder", "prairie")
predator_prairie <- Plotify_troph_type("Predator", "prairie")
fish_prairie <- Plotify_troph_type("Fish", "prairie")
```

```{r}
ggarrange(collector_prairie,grazer_prairie,shredder_prairie,predator_prairie,fish_prairie, 
          labels = c('Collector','Grazer','Shredder','Predator','Fish'),
          ncol=3,
          nrow = 2,
          common.legend=TRUE,
          legend="right")
```
Performing QQ plots to check normality of samples

```{r}
qq_grazer <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Grazer'),], x="d13C_norm", color="type")
qq_collector <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Collector'),], x="d13C_norm", color="type")
qq_shredder <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Shredder'),], x="d13C_norm", color="type")
qq_predator <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Predator'),], x="d13C_norm", color="type")
qq_fish <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Fish'),], x="d13C_norm", color="type")

ggarrange(qq_collector,qq_grazer,qq_shredder,qq_predator,qq_fish,
          labels = c('A','B','C','D','E'),
          ncol=3,
          nrow = 2,
          label.x = 0,
          common.legend=TRUE,
          legend="right")
```

```{r}
df_troph <- df[, c('type',"troph_func","d15N_norm","d13C_norm")]
stat.test <- df_troph %>%
  group_by(troph_func) %>%
  t_test(d13C_norm ~ type, p.adjust.method = "bonferroni")
stat.test <- stat.test %>% select(-.y., -statistic, -df)
```

```{r}
Boxplot_carbon <- ggboxplot(
  df_troph, x = "type", y = "d13C_norm", legend = "none")+xlab('Land Use')+ylab('δ13C (‰)')+theme_bw() +
  facet_wrap(~troph_func)+scale_x_discrete(labels=c("Wastelands","Woods",'Prairies','Softwood'))
# Add statistical test p-values
stat.test <- stat.test %>% add_xy_position(x = "type")
Boxplot_carbon + stat_pvalue_manual(stat.test[stat.test$p.adj.signif != 'ns',], label = "p.adj.signif")
```
```{r}
qq_grazer_N <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Grazer'),], x="d15N_norm", color="type")
qq_collector_N <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Collector'),], x="d15N_norm", color="type")
qq_shredder_N <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Shredder'),], x="d15N_norm", color="type")
qq_predator_N <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Predator'),], x="d15N_norm", color="type")
qq_fish_N <- ggqqplot(data=df_troph[df_troph$troph_func == as.character('Fish'),], x="d15N_norm", color="type")

ggarrange(qq_collector_N,qq_grazer_N,qq_shredder_N,qq_predator_N,qq_fish_N,
          labels = c('A','B','C','D','E'),
          ncol=3,
          nrow = 2,
          label.x = 0,
          common.legend=TRUE,
          legend="right")
```
```


```{r}
stat.test <- df_troph %>%
  group_by(troph_func) %>%
  t_test(d15N_norm ~ type, p.adjust.method = "bonferroni")
stat.test <- stat.test %>% select(-.y., -statistic, -df)
Boxplot_nitrogen <- ggboxplot(
  df_troph, x = "type", y = "d15N_norm", legend = "none")+xlab('Land Use')+ylab('δ15N (‰)')+theme_bw() +
  facet_wrap(~troph_func)+scale_x_discrete(labels=c("Wastelands","Woods",'Prairies','Softwood'))
# Add statistical test p-values
stat.test <- stat.test %>% add_xy_position(x = "type")
Boxplot_nitrogen + stat_pvalue_manual(stat.test[stat.test$p.adj.signif != 'ns',], label = "p.adj.signif")
```

```{r}
var.test(df_troph[df_troph$troph_func == as.character('Grazer') & df_troph$type == as.character('prairie'),]$d15N_norm, df_troph[df_troph$troph_func == as.character('Grazer') & df_troph$type == as.character('resineux'),]$d15N_norm, alternative = "greater")
```

```{r}
#create function with Welch Two sample t-tests significant results as output

F_test_type_alt <- function(troph,type1,type2,alternative_asked){
  x <- df_troph[df_troph$troph_func == as.character(troph),]%>%
         filter(type ==as.character(type1)) 
  y <- df_troph[df_troph$troph_func == as.character(troph),]%>%
         filter(type ==as.character(type2)) 
  if (nrow(x)>1 & nrow(y)>1){
  test <- var.test(x$d15N_norm,y$d15N_norm,alternative=as.character(alternative_asked))
  }
  else {
    test <- NaN
  }
  return(test)
}
```


```{r}
N_var_F_test <- function(troph) {
  #create empty df
  N_var_colnames <- c('different','greater','less')
  N_var_df <- data.frame(matrix(nrow=length(c(colnames(df_p_values)[c(2:length(df_p_values))])),ncol=length(N_var_colnames)))
  colnames(N_var_df) <- N_var_colnames
  N_var_df$troph_func <- rep(troph,nrow(N_var_df))
  N_var_df$comparison <- c(colnames(df_p_values)[c(2:length(df_p_values))])
  
  #significance threshold
  thr <- 0.05
  
  if (any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'bois')& any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'friche')){
    test_two_sided <- F_test_type_alt(troph,'bois','friche','two.sided')
    test_greater <- F_test_type_alt(troph,'bois','friche','greater')
    test_less <- F_test_type_alt(troph,'bois','friche','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {
        if (i < thr){
         N_var_df[1,match(i,test_list)] <- i
        }
        else{
         N_var_df[1,match(i,test_list)] <- "ns"
        }
      }
    }
  }

  if (any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'bois')& any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'prairie')){
    test_two_sided <- F_test_type_alt(troph,'bois','prairie','two.sided')
    test_greater <- F_test_type_alt(troph,'bois','prairie','greater')
    test_less <- F_test_type_alt(troph,'bois','prairie','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {      
        if (i < thr){
          N_var_df[2,match(i,test_list)] <- i
        }
        else{
          N_var_df[2,match(i,test_list)] <- "ns"
        }
       }
     }
   }

  if (any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'prairie')& any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'friche')){
    test_two_sided <- F_test_type_alt(troph,'prairie','friche','two.sided')
    test_greater <- F_test_type_alt(troph,'prairie','friche','greater')
    test_less <- F_test_type_alt(troph,'prairie','friche','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
       for (i in test_list) { 
        if (i < thr){
         N_var_df[3,match(i,test_list)] <- i
        }
        else{
         N_var_df[3,match(i,test_list)] <- "ns"
        }
       }
     }
  }

  if (any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'bois')& any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'resineux')){
    test_two_sided <- F_test_type_alt(troph,'bois','resineux','two.sided')
    test_greater <- F_test_type_alt(troph,'bois','resineux','greater')
    test_less <- F_test_type_alt(troph,'bois','resineux','less')
    
    
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
        test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
        for (i in test_list) {
          if (i < thr){
           N_var_df[4,match(i,test_list)] <- i
          }
          else{
           N_var_df[4,match(i,test_list)] <- "ns"
          }
        }
      }
  }

  if (any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'resineux')& any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'friche')){
    test_two_sided <- F_test_type_alt(troph,'resineux','friche','two.sided')
    test_greater <- F_test_type_alt(troph,'resineux','friche','greater')
    test_less <- F_test_type_alt(troph,'resineux','friche','less')
    
      if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
        test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
        for (i in test_list) {     
          if (i < thr){
            N_var_df[5,match(i,test_list)] <- i
          }
          else{
            N_var_df[5,match(i,test_list)] <- "ns"
          }
        }
      }
  }

  if (any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'resineux')& any(df_troph[df_troph$troph_func == as.character(troph),]$type == 'prairie')){
    test_two_sided <- F_test_type_alt(troph,'resineux','prairie','two.sided')
    test_greater <- F_test_type_alt(troph,'resineux','prairie','greater')
    test_less <- F_test_type_alt(troph,'resineux','prairie','less')
    
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {
       if (i < thr){
        N_var_df[6,match(i,test_list)] <- i
       }
       else{
        N_var_df[6,match(i,test_list)] <- "ns"
       }
      }
    }
  }
  
return(N_var_df)
}
```


```{r}
N_var_collector <- N_var_F_test('Collector')
N_var_grazer <- N_var_F_test('Grazer')
N_var_shredder <- N_var_F_test('Shredder')
N_var_predator <- N_var_F_test('Predator')
N_var_fish <- N_var_F_test('Fish')

N_var_all <- rbind(N_var_collector,N_var_grazer,N_var_shredder,N_var_predator,N_var_fish)
N_var_prairies <- N_var_all[grep("Prairies", N_var_all$comparison), ]%>% select(-different)%>%  mutate_if(is.numeric, round, digits = 4)
```

```{r}
# #setting the work direction
# setwd("C:\\Users\\cbodson\\Desktop")
# write.xlsx(N_var_prairies, "Prairies_var_significant.xlsx")
```

taxon by taxon

```{r}
baet_prairie <- Plotify_taxon_type('BAET','prairie')+scale_colour_manual(values=c("#ff595e", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93"))
calop_prairie <- Plotify_taxon_type('CALOP','prairie')+scale_colour_manual(values=c("#ff595e", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93"))
simu_prairie <- Plotify_taxon_type('SIMU','prairie')+scale_colour_manual(values=c("#ff595e", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93"))
hepta_prairie <- Plotify_taxon_type('HEPTA','prairie')+scale_colour_manual(values=c("#ff595e", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93"))
gam_prairie <- Plotify_taxon_type('GAM','prairie')+scale_colour_manual(values=c("#ff595e", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93"))
hydrop_prairie <- Plotify_taxon_type('HYDROP','prairie')+scale_colour_manual(values=c("#ff595e", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93"))
perl_prairie <- Plotify_taxon_type('PERL','prairie')+scale_colour_manual(values=c("#ff595e", "#ffca3a",  "#6a4c93"))
rhyaco_prairie <- Plotify_taxon_type('RHYACO','prairie')+scale_colour_manual(values=c("#ff595e", "#8ac926", "#1982c4", "#6a4c93"))
vai_prairie <- Plotify_taxon_type('VAI','prairie')+scale_colour_manual(values=c("#ffca3a", "#6a4c93"))
trf_prairie <- Plotify_taxon_type('TRF','prairie')+scale_colour_manual(values=c("#ff595e", "#1982c4"))
```

```{r}
ggarrange(baet_prairie,calop_prairie,gam_prairie,hepta_prairie,hydrop_prairie,perl_prairie,rhyaco_prairie,simu_prairie,vai_prairie,trf_prairie, 
          labels = c('A','B','C','D','E','F','G','H','I','J'),
          ncol=4,
          nrow = 3,
          common.legend=TRUE,
          legend="right")
```
Boxplots

```{r}
bois_bc <- ggplot(df[df$type ==as.character('bois'),])+geom_boxplot(aes(taxon_clean,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Taxa')+ylab('δ13C (‰)')
prairie_bc <- ggplot(df[df$type ==as.character('prairie'),])+geom_boxplot(aes(taxon_clean,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Taxa')+ylab('δ13C (‰)')
friche_bc  <- ggplot(df[df$type ==as.character('friche'),])+geom_boxplot(aes(taxon_clean,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Taxa')+ylab('δ13C (‰)')
resineux_bc <- ggplot(df[df$type ==as.character('resineux'),])+geom_boxplot(aes(taxon_clean,d13C_norm))+coord_flip()+ylim(xmin,xmax)+xlab('Taxa')+ylab('δ13C (‰)')

bois_bn <- ggplot(df[df$type ==as.character('bois'),])+geom_boxplot(aes(taxon_clean,d15N_norm))+ylim(ymin,ymax)+xlab('Taxa')+ylab('δ15N (‰)')
prairie_bn <- ggplot(df[df$type ==as.character('prairie'),])+geom_boxplot(aes(taxon_clean,d15N_norm))+ylim(ymin,ymax)+xlab('Taxa')+ylab('δ15N (‰)')
friche_bn  <- ggplot(df[df$type ==as.character('friche'),])+geom_boxplot(aes(taxon_clean,d15N_norm))+ylim(ymin,ymax)+xlab('Taxa')+ylab('δ15N (‰)')
resineux_bn <- ggplot(df[df$type ==as.character('resineux'),])+geom_boxplot(aes(taxon_clean,d15N_norm))+ylim(ymin,ymax)+xlab('Taxa')+ylab('δ15N (‰)')
```

```{r}
baet_box_carbon <- Boxplot_carbon_taxon('BAET')
calop_box_carbon <- Boxplot_carbon_taxon('CALOP')
gam_box_carbon <- Boxplot_carbon_taxon('GAM')
hepta_box_carbon <- Boxplot_carbon_taxon('HEPTA')
hydrop_box_carbon <- Boxplot_carbon_taxon('HYDROP')
perl_box_carbon <- Boxplot_carbon_taxon('PERL')
rhyaco_box_carbon <- Boxplot_carbon_taxon('RHYACO')
simu_box_carbon <- Boxplot_carbon_taxon('SIMU')
trf_box_carbon <- Boxplot_carbon_taxon('TRF')
vai_box_carbon <- Boxplot_carbon_taxon('VAI')

baet_box_nitrogen <- Boxplot_nitrogen_taxon('BAET')
calop_box_nitrogen <- Boxplot_nitrogen_taxon('CALOP')
gam_box_nitrogen <- Boxplot_nitrogen_taxon('GAM')
hepta_box_nitrogen <- Boxplot_nitrogen_taxon('HEPTA')
hydrop_box_nitrogen <- Boxplot_nitrogen_taxon('HYDROP')
perl_box_nitrogen <- Boxplot_nitrogen_taxon('PERL')
rhyaco_box_nitrogen <- Boxplot_nitrogen_taxon('RHYACO')
simu_box_nitrogen <- Boxplot_nitrogen_taxon('SIMU')
trf_box_nitrogen <- Boxplot_nitrogen_taxon('TRF')
vai_box_nitrogen <- Boxplot_nitrogen_taxon('VAI')

```


Boxplot by taxon for Carbon
```{r}

ggarrange(baet_box_carbon,calop_box_carbon,gam_box_carbon,hepta_box_carbon,hydrop_box_carbon,perl_box_carbon,rhyaco_box_carbon,simu_box_carbon,vai_box_carbon,trf_box_carbon, 
          labels = c('A','B','C','D','E','F','G','H','I','J'),
          ncol=4,
          nrow = 3)
```


```{r}
#create function with Welch Two sample t-tests significant results as output

t_test_type_alt <- function(taxon_name,type1,type2,alternative_asked){
  x <- df[df$taxon_clean == as.character(taxon_name),]%>%
         filter(type ==as.character(type1)) %>%
         select('d13C_norm')
  y <- df[df$taxon_clean == as.character(taxon_name),]%>%
         filter(type ==as.character(type2)) %>%
         select('d13C_norm')
  if (nrow(x)>1 & nrow(y)>1){
  test <- t.test(x,y,alternative=as.character(alternative_asked))
  }
  else {
    test <- NaN
  }
  return(test)
}
```


```{r}
c_mean_t_test <- function(taxon_name) {
  #create empty df
  c_mean_colnames <- c('different','greater','less','taxon')
  c_mean_df <- data.frame(matrix(nrow=length(c(colnames(df_p_values)[c(2:length(df_p_values))])),ncol=length(c_mean_colnames)))
  colnames(c_mean_df) <- c_mean_colnames
  c_mean_df$taxon <- rep(taxon_name,nrow(c_mean_df))
  c_mean_df$comparison <- c(colnames(df_p_values)[c(2:length(df_p_values))])
  
  #significance threshold
  thr <- 0.05
  
  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
    test_two_sided <- t_test_type_alt(taxon_name,'bois','friche','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'bois','friche','greater')
    test_less <- t_test_type_alt(taxon_name,'bois','friche','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {
        if (i < thr){
         c_mean_df[1,match(i,test_list)] <- TRUE
        }
        else{
         c_mean_df[1,match(i,test_list)] <- FALSE
        }
      }
    }
  }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')){
    test_two_sided <- t_test_type_alt(taxon_name,'bois','prairie','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'bois','prairie','greater')
    test_less <- t_test_type_alt(taxon_name,'bois','prairie','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {      
        if (i < thr){
          c_mean_df[2,match(i,test_list)] <- TRUE
        }
        else{
          c_mean_df[2,match(i,test_list)] <- FALSE
        }
       }
     }
   }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
    test_two_sided <- t_test_type_alt(taxon_name,'prairie','friche','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'prairie','friche','greater')
    test_less <- t_test_type_alt(taxon_name,'prairie','friche','less')
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
       for (i in test_list) { 
        if (i < thr){
         c_mean_df[3,match(i,test_list)] <- TRUE
        }
        else{
         c_mean_df[3,match(i,test_list)] <- FALSE
        }
       }
     }
  }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')){
    test_two_sided <- t_test_type_alt(taxon_name,'bois','resineux','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'bois','resineux','greater')
    test_less <- t_test_type_alt(taxon_name,'bois','resineux','less')
    
    
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
        test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
        for (i in test_list) {
          if (i < thr){
           c_mean_df[4,match(i,test_list)] <- TRUE
          }
          else{
           c_mean_df[4,match(i,test_list)] <- FALSE
          }
        }
      }
  }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
    test_two_sided <- t_test_type_alt(taxon_name,'resineux','friche','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'resineux','friche','greater')
    test_less <- t_test_type_alt(taxon_name,'resineux','friche','less')
    
      if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
        test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
        for (i in test_list) {     
          if (i < thr){
            c_mean_df[5,match(i,test_list)] <- TRUE
          }
          else{
            c_mean_df[5,match(i,test_list)] <- FALSE
          }
        }
      }
  }

  if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')){
    test_two_sided <- t_test_type_alt(taxon_name,'resineux','prairie','two.sided')
    test_greater <- t_test_type_alt(taxon_name,'resineux','prairie','greater')
    test_less <- t_test_type_alt(taxon_name,'resineux','prairie','less')
    
  
    if (!any(is.na(test_two_sided)) & !any(is.na(test_greater)) & !any(is.na(test_less))){
      test_list <- c(test_two_sided$p.value,test_greater$p.value,test_less$p.value)
      for (i in test_list) {
       if (i < thr){
        c_mean_df[6,match(i,test_list)] <- TRUE
       }
       else{
        c_mean_df[6,match(i,test_list)] <- FALSE
       }
      }
    }
  }
  
return(c_mean_df)
}
```

```{r}
c_mean_baet <- c_mean_t_test('BAET')
c_mean_calop <- c_mean_t_test('CALOP')
c_mean_gam <- c_mean_t_test('GAM')
c_mean_hepta <- c_mean_t_test('HEPTA')
c_mean_hydrop <- c_mean_t_test('HYDROP')
c_mean_perl <- c_mean_t_test('PERL')
c_mean_rhyaco <- c_mean_t_test('RHYACO')
c_mean_simu <- c_mean_t_test('SIMU')
c_mean_vai <- c_mean_t_test('VAI')
c_mean_trf <- c_mean_t_test('TRF')
c_mean_all <- rbind(c_mean_baet,c_mean_calop,c_mean_gam,c_mean_hepta,c_mean_hydrop,c_mean_perl,c_mean_rhyaco,c_mean_simu,c_mean_vai,c_mean_trf)
```


Boxplot by taxon for Nitrogen
```{r}
ggarrange(baet_box_nitrogen,calop_box_nitrogen,gam_box_nitrogen,hepta_box_nitrogen,hydrop_box_nitrogen,perl_box_nitrogen,rhyaco_box_nitrogen,simu_box_nitrogen,vai_box_nitrogen,trf_box_nitrogen, 
          labels = c("baet","calop","gam","hepta","hydrop","perl","rhyaco","simu","vai","trf"),
          ncol=4,
          nrow = 3)
```
Same by land use type, but not the most judicious
```{r}
ggarrange(bois_bc, friche_bc, prairie_bc, resineux_bc, 
          labels = c("bois", "friche", "prairie", "resineux"),
          ncol=2,
          nrow = 2)
```

```{r}
ggarrange(bois_bn, friche_bn, prairie_bn, resineux_bn, 
          labels = c("bois", "friche", "prairie", "resineux"),
          ncol=2,
          nrow = 2)
```
Looking further into impact feeding behavior
```{r}
ggplot(df[df$type ==as.character('prairie'),])+geom_point(aes(d13C_norm,d15N_norm, color=troph_func))
```
```{r}
# bois <- Plotify_type('bois')
# friche <- Plotify_type('friche')
# prairie <- Plotify_type('prairie')
# resineux <- Plotify_type('resineux')
# 
# #creates a hull for isotopic area
# 
# bois_hull <- bois+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=taxon_clean), expand = 0, radius = 0)
# friche_hull <- friche+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=taxon_clean), expand = 0, radius = 0)
# prairie_hull <- prairie+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=taxon_clean), expand = 0, radius = 0)
# resineux_hull <- resineux+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=taxon_clean), expand = 0, radius = 0)

```

Isotopic frame in function of land use, not the most judicious as we separate the factors we want to compare

```{r}
# #png("C:/Users/cbodson/Desktop/test.png",
# #    width=640, height=500)
# ggarrange(bois, friche, prairie, resineux, 
#           labels = c("bois", "friche", "prairie", "resineux"),
#           label.x = 0,
#           label.y = 1,
#           ncol=2,
#           nrow = 2,
#           common.legend=TRUE,
#           legend='right')
# #dev.off()
```

Same with isotopic areas

```{r}
# png("C:/Users/cbodson/Desktop/test.png",
#     width=640, height=500)
# ggarrange(bois_hull, friche_hull, prairie_hull, resineux_hull, 
#           labels = c("bois", "friche", "prairie", "resineux"),
#           label.x = 0,
#           label.y = 1,
#           ncol=2,
#           nrow = 2,
#           common.legend=TRUE,
#           legend='right')
# dev.off()
```

Isotopic frame by taxon
```{r}

baet <- Plotify_taxon('BAET')
calop <- Plotify_taxon('CALOP')
simu <- Plotify_taxon('SIMU')
hepta <- Plotify_taxon('HEPTA')
gam <- Plotify_taxon('GAM')
hydrop <- Plotify_taxon('HYDROP')+scale_colour_manual(values=c("#F8766D","#00BFC4","#C77CFF"))
perl <- Plotify_taxon('PERL')
rhyaco <- Plotify_taxon('RHYACO')
vai <- Plotify_taxon('VAI')
trf <- Plotify_taxon('TRF')
```

```{r}
#ggarange takes the legend of the first plot for common legends
#png("C:/Users/cbodson/Desktop/Isotopic_Frame_by_taxon.png", width=750, height=500)
ggarrange(baet+scale_color_manual(name='Land Use', values=c("#F8766D","#7CAE00","#00BFC4","#C77CFF"),labels=c("Woods","Wastelands","Prairies","Softwoods")),calop,gam,hepta,hydrop,perl,rhyaco,simu,vai,trf, 
          labels = c('A','B','C','D','E','F','G','H','I','J'),
          ncol=4,
          nrow = 3,
          label.x = 0.1,
          common.legend=TRUE,
          legend="right")
#dev.off()
```

Areas for each taxon in function of land use
+ procedure for PERMANOVA to test whether clusters are different two by two

```{r}
#Adonis doesn't want negative values for PERMANOVA
df$C_absolute <- as.numeric(lapply(df$d13C_norm, function(x){abs(x)}))
```

```{r}
Test_hull_taxon <- function(taxon_name){

#Initializing vector with pairwise test p_values
pairwise_p <- numeric()
pairwise_r2 <- numeric()

taxon_test <-df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute')]

set.seed(46) #to ensure reproducibilty as we use permutations


ado_all <-adonis2(taxon_test~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')])

#Takes p-value and R2 results
pairwise_p['all'] <- ado_all$`Pr(>F)`[1]
pairwise_r2['all'] <- ado_all$R2[1]

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
  taxon_bf <- df[df$taxon_clean== as.character(taxon_name),] %>%  #clean with only land uses of interest
    filter(type =='bois'|type=='friche') %>%
    select(c('d15N_norm','C_absolute'))
  ado_bf <-adonis2(taxon_bf~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%filter(type =='bois'|type=='friche'))
  pairwise_p['bois vs. friche'] <- ado_bf$`Pr(>F)`[1]
  pairwise_r2['bois vs. friche'] <- ado_bf$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')){
taxon_bp <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='bois'|type=='prairie') %>%
  select(c('d15N_norm','C_absolute'))
ado_bp <-adonis2(taxon_bp~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='bois'|type=='prairie'))
pairwise_p['bois vs. prairie'] <- ado_bp$`Pr(>F)`[1]
pairwise_r2['bois vs. prairie'] <- ado_bp$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
taxon_pf <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='prairie'|type=='friche') %>%
  select(c('d15N_norm','C_absolute'))
ado_pf <-adonis2(taxon_pf~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='prairie'|type=='friche'))
pairwise_p['prairie vs. friche'] <- ado_pf$`Pr(>F)`[1]
pairwise_r2['prairie vs. friche'] <- ado_pf$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'bois')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')){
taxon_br <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='bois'|type=='resineux') %>%
  select(c('d15N_norm','C_absolute'))
ado_br <-adonis2(taxon_br~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='bois'|type=='resineux'))
pairwise_p['bois vs. resineux'] <- ado_br$`Pr(>F)`[1]
pairwise_r2['bois vs. resineux'] <- ado_br$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'friche')){
taxon_rf <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='resineux'|type=='friche') %>%
  select(c('d15N_norm','C_absolute'))
ado_rf <-adonis2(taxon_rf~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='resineux'|type=='friche'))
pairwise_p['resineux vs. friche'] <- ado_rf$`Pr(>F)`[1]
pairwise_r2['resineux vs. friche'] <- ado_rf$R2[1]
}

if (any(df[df$taxon_clean== as.character(taxon_name),]$type == 'resineux')& any(df[df$taxon_clean== as.character(taxon_name),]$type == 'prairie')){
taxon_rp <- df[df$taxon_clean== as.character(taxon_name),] %>%
  filter(type =='resineux'|type=='prairie') %>%
  select(c('d15N_norm','C_absolute'))
ado_rp <-adonis2(taxon_rp~type,data=df[df$taxon_clean== as.character(taxon_name), c('d15N_norm','C_absolute','type')]%>%
  filter(type =='resineux'|type=='prairie'))
pairwise_p['resineux vs. prairie'] <- ado_rp$`Pr(>F)`[1]
pairwise_r2['resineux vs. prairie'] <- ado_rp$R2[1]
}

#As we increase the number of comparisons, we also increase the risk of rejecting the false hypothesis so we need to adjust p-values
adjusted_pairwise_p <- data.frame(t(data.frame(p.adjust(pairwise_p))))
rownames(adjusted_pairwise_p) <- 'pairwise_p'
data.frame(t(data.frame(pairwise_r2)))

return(rbind(adjusted_pairwise_p,data.frame(t(data.frame(pairwise_r2)))))
}

```

```{r}
baet_hull<- baet+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
baet_hull
```

```{r}
Test_hull_taxon('BAET')
```

```{r}
calop_hull <- calop+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```

```{r}
Test_hull_taxon('CALOP')
```

```{r}
gam_hull<- gam+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```

```{r}
Test_hull_taxon('GAM')
```

```{r}
hepta_hull <- hepta+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```

```{r}
Test_hull_taxon('HEPTA')
```

```{r}
#!!! ADJUST COLORS ON INKSCAPE
hydrop_hull <- hydrop+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
hydrop_hull
```

```{r}
Test_hull_taxon('HYDROP')
```

```{r}
perl_hull <- perl+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```

```{r}
Test_hull_taxon('PERL')
```

```{r}
rhyaco_hull <- rhyaco+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```

```{r}
Test_hull_taxon('RHYACO')
```

```{r}
simu_hull <- simu+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```

```{r}
Test_hull_taxon('SIMU')
```

```{r}
vai_hull <- vai+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```

```{r}
Test_hull_taxon('VAI')
```

```{r}
trf_hull <- trf+geom_mark_hull(aes(d13C_norm,d15N_norm, fill=type), expand = 0, radius = 0)+theme(plot.margin=unit(c(1,0.5,0.2,0.5),"cm"))
```


```{r}
Test_hull_taxon('TRF')
```

```{r}
# #!!! Correct legend and colors in INKSCAPE
# ggarrange(baet_hull,calop_hull,gam_hull,hepta_hull,hydrop_hull,perl_hull,rhyaco_hull,simu_hull,vai_hull,trf_hull, 
#           labels = c('A','B','C','D','E','F','G','H','I','J'),
#           ncol=4,
#           nrow = 3,
#           label.x = 0.1,
#           common.legend=TRUE,
#           legend="right")
```


```{r}
# #Gathering all data into 2 dataframes, p-values indicate significance of the difference observed whether it's small or large, and R2 indicate the proportion of variation explained by the model (here by the type of land use)
# df_p_values <- rbind.fill(Test_hull_taxon('BAET')['pairwise_p',],
#                           Test_hull_taxon('CALOP')['pairwise_p',],
#                           Test_hull_taxon('GAM')['pairwise_p',],
#                           Test_hull_taxon('HEPTA')['pairwise_p',],
#                           Test_hull_taxon('HYDROP')['pairwise_p',],
#                           Test_hull_taxon('PERL')['pairwise_p',],
#                           Test_hull_taxon('RHYACO')['pairwise_p',],
#                           Test_hull_taxon('SIMU')['pairwise_p',],
#                           Test_hull_taxon('VAI')['pairwise_p',],
#                           Test_hull_taxon('TRF')['pairwise_p',])
# rownames(df_p_values) <- c('Baetidae', 'Calopterygidae', 'Gammaridae', 'Heptageniidae', 'Hydropsychidae', 'Perlidae', 'Rhyacophilidae', 'Simuliidae', 'Salmo Trutta', 'Phoxinus phoxinus')
# colnames(df_p_values) <- c('All', "Woods/Wasteland"," Woods/Prairies", "Prairies/Wasteland", "Woods/Softwoods", "Softwoods/Wasteland", "Softwoods/Prairies")
# 
# df_r2_values <- rbind.fill(Test_hull_taxon('BAET')['pairwise_r2',],
#                           Test_hull_taxon('CALOP')['pairwise_r2',],
#                           Test_hull_taxon('GAM')['pairwise_r2',],
#                           Test_hull_taxon('HEPTA')['pairwise_r2',],
#                           Test_hull_taxon('HYDROP')['pairwise_r2',],
#                           Test_hull_taxon('PERL')['pairwise_r2',],
#                           Test_hull_taxon('RHYACO')['pairwise_r2',],
#                           Test_hull_taxon('SIMU')['pairwise_r2',],
#                           Test_hull_taxon('VAI')['pairwise_r2',],
#                           Test_hull_taxon('TRF')['pairwise_r2',])
# rownames(df_r2_values) <- c('Baetidae', 'Calopterygidae', 'Gammaridae', 'Heptageniidae', 'Hydropsychidae', 'Perlidae', 'Rhyacophilidae', 'Simuliidae', 'Salmo Trutta', 'Phoxinus phoxinus')
# colnames(df_r2_values) <- c('All', "Woods/Wasteland"," Woods/Prairies", "Prairies/Wasteland", "Woods/Softwoods", "Softwoods/Wasteland", "Softwoods/Prairies")
# 
# df_r2_values <- df_r2_values%>%  mutate_if(is.numeric, round, digits = 3)
# df_p_values
```
```{r}
# mask_df <- data.frame(lapply(df_p_values, function(x){x<0.05}))
# df_r2_signi <- data.frame(mapply(function(x, y) ifelse(y, x, "X"), df_r2_values, mask_df))
# rownames(df_r2_signi) <- c('Baetidae', 'Calopterygidae', 'Gammaridae', 'Heptageniidae', 'Hydropsychidae', 'Perlidae', 'Rhyacophilidae', 'Simuliidae', 'Salmo Trutta', 'Phoxinus phoxinus')
# colnames(df_r2_signi) <- c('All', "Woods/Wasteland"," Woods/Prairies", "Prairies/Wasteland", "Woods/Softwoods", "Softwoods/Wasteland", "Softwoods/Prairies")
# df_r2_signi
# ```

#```{r}
# #setting the work direction
# setwd("C:\\Users\\cbodson\\Desktop")
# write.xlsx(df_r2_signi, "Areas_r2_significant.xlsx")
```
